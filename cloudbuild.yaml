options:
  logging: CLOUD_LOGGING_ONLY

substitutions:
  _REGION: us-central1
  _BACKEND_SERVICE: netflix-backend
  _FRONTEND_SERVICE: netflix-frontend
  _BACKEND_URL: ""  # API endpoint for frontend
  _PROJECT_ID: project-4ef36a3c-319a-4cbc-93a

steps:

# Build Backend
- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Backend'
  args:
    - build
    - -t
    - us-central1-docker.pkg.dev/$PROJECT_ID/app-repo/backend:$SHORT_SHA
    - ./backend

# Push Backend
- name: 'gcr.io/cloud-builders/docker'
  id: 'Push Backend'
  args:
    - push
    - us-central1-docker.pkg.dev/$PROJECT_ID/app-repo/backend:$SHORT_SHA
  waitFor: ['Build Backend']

# Deploy Backend (with Cloud SQL + Secret Manager)
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: 'Deploy Backend'
  entrypoint: gcloud
  args:
    - run
    - deploy
    - $_BACKEND_SERVICE
    - --image=us-central1-docker.pkg.dev/$PROJECT_ID/app-repo/backend:$SHORT_SHA
    - --region=$_REGION
    - --platform=managed
    - --allow-unauthenticated
    - --add-cloudsql-instances=project-4ef36a3c-319a-4cbc-93a:us-central1:netflix-postgres   # replace with your Cloud SQL instance connection name
    - --set-env-vars=DB_USER=netflixuser,DB_NAME=netflixdb,DB_CONNECTION_NAME=project-4ef36a3c-319a-4cbc-93a:us-central1:netflix-postgres
    - --set-secrets=DB_PASS=DB_PASS:latest               # pulls password from Secret Manager
    - --project=$_PROJECT_ID
  waitFor: ['Push Backend']

# Build Frontend
- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Frontend'
  args:
    - build
    - --build-arg
    - REACT_APP_API=$_BACKEND_URL
    - -t
    - us-central1-docker.pkg.dev/$PROJECT_ID/app-repo/frontend:$SHORT_SHA
    - ./frontend

# Push Frontend
- name: 'gcr.io/cloud-builders/docker'
  id: 'Push Frontend'
  args:
    - push
    - us-central1-docker.pkg.dev/$PROJECT_ID/app-repo/frontend:$SHORT_SHA
  waitFor: ['Build Frontend']

# Deploy Frontend
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: 'Deploy Frontend'
  entrypoint: gcloud
  args:
    - run
    - deploy
    - $_FRONTEND_SERVICE
    - --image=us-central1-docker.pkg.dev/$PROJECT_ID/app-repo/frontend:$SHORT_SHA
    - --region=$_REGION
    - --platform=managed
    - --allow-unauthenticated
  waitFor: ['Push Frontend']
